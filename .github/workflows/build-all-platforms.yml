name: ðŸš€ å››ç«¯è‡ªåŠ¨æž„å»º

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘ï¼Œå¯é€‰æ‹©å¹³å°
    inputs:
      platform:
        description: 'é€‰æ‹©è¦æž„å»ºçš„å¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - android
          - mac
          - windows
          - ios
  push:
    branches:
      - main
    paths:
      - 'desktop-apps/**'
      - '.github/workflows/build-all-platforms.yml'

jobs:
  # ===== Android æž„å»º =====
  build-android:
    name: ðŸ“± æž„å»º Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: è§£ç å¹¶è®¾ç½®ç­¾åå¯†é’¥
        working-directory: desktop-apps/android-twa
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "âœ… ä½¿ç”¨å‘å¸ƒç­¾åå¯†é’¥"
            echo "$KEYSTORE_BASE64" | base64 -d > mornhub-release.keystore
            ls -lh mornhub-release.keystore
          else
            echo "âš ï¸  æœªé…ç½®ç­¾åå¯†é’¥ï¼Œå°†ä½¿ç”¨è°ƒè¯•ç­¾å"
          fi

      - name: æž„å»º Android APK
        working-directory: desktop-apps/android-twa
        env:
          KEYSTORE_FILE: ${{ github.workspace }}/desktop-apps/android-twa/mornhub-release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon

      - name: ä¸Šä¼  APK
        uses: actions/upload-artifact@v4
        with:
          name: SiteHub-Android
          path: desktop-apps/android-twa/app/build/outputs/apk/release/*.apk
          retention-days: 30

  # ===== Mac æž„å»º =====
  build-mac:
    name: ðŸŽ æž„å»º Mac DMG (Universal)
    runs-on: macos-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal

      - name: æ·»åŠ  Rust ç›®æ ‡ (Intel + Apple Silicon)
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: å®‰è£… Tauri CLI
        run: cargo install tauri-cli

      - name: æž„å»º Mac Universal Binary
        working-directory: desktop-apps/mac-tauri
        run: cargo tauri build --target universal-apple-darwin

      - name: ä¸Šä¼  DMG (Universal)
        uses: actions/upload-artifact@v4
        with:
          name: SiteHub-Mac-Universal
          path: desktop-apps/mac-tauri/src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
          retention-days: 30

  # ===== iOS æž„å»º =====
  build-ios:
    name: ðŸ“± æž„å»º iOS IPA
    runs-on: macos-latest
    # åªæœ‰å½“é…ç½®äº†è¯ä¹¦æ—¶æ‰æž„å»º (æ£€æŸ¥ APPLE_CERTIFICATE secret æ˜¯å¦å­˜åœ¨)
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios' || github.event_name == 'push' }}

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å®‰è£…ä¾èµ–
        working-directory: desktop-apps/ios-capacitor
        run: npm install

      - name: Capacitor Sync
        working-directory: desktop-apps/ios-capacitor
        run: npx cap sync ios

      - name: è®¾ç½® Xcode ç‰ˆæœ¬
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: å®‰è£… CocoaPods
        run: sudo gem install cocoapods

      - name: Pod Install
        working-directory: desktop-apps/ios-capacitor/ios/App
        run: pod install

      # è¯ä¹¦å¯¼å…¥å’Œæž„å»ºæ­¥éª¤ï¼ˆå¦‚æžœæ²¡æœ‰é…ç½®è¯ä¹¦ä¼šå¤±è´¥ï¼Œä½†ä¸å½±å“å…¶ä»–å¹³å°ï¼‰
      - name: å¯¼å…¥Appleè¯ä¹¦
        continue-on-error: true
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "âš ï¸  æœªé…ç½® APPLE_CERTIFICATEï¼Œè·³è¿‡è¯ä¹¦å¯¼å…¥"
            echo "è¯·å‚è€ƒ desktop-apps/ios-capacitor/IOS_BUILD_GUIDE.md é…ç½®è¯ä¹¦"
            exit 1
          fi

          # åˆ›å»ºä¸´æ—¶ keychainï¼ˆä½¿ç”¨éšæœºå¯†ç ï¼‰
          KEYCHAIN_PASSWORD=$(uuidgen)
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # å¯¼å…¥è¯ä¹¦
          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: å¯¼å…¥ Provisioning Profile
        continue-on-error: true
        env:
          APPLE_PROVISIONING_PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE }}
        run: |
          if [ -z "$APPLE_PROVISIONING_PROFILE" ]; then
            echo "âš ï¸  æœªé…ç½® APPLE_PROVISIONING_PROFILEï¼Œè·³è¿‡ Profile å¯¼å…¥"
            exit 1
          fi

          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          echo -n "$APPLE_PROVISIONING_PROFILE" | base64 --decode -o $PP_PATH
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

      - name: æž„å»º iOS åº”ç”¨
        continue-on-error: true
        working-directory: desktop-apps/ios-capacitor/ios/App
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "âš ï¸  æœªé…ç½®è¯ä¹¦ï¼Œè·³è¿‡ iOS æž„å»º"
            echo "iOS æž„å»ºéœ€è¦ Apple å¼€å‘è€…è¯ä¹¦ï¼Œè¯·å‚è€ƒ IOS_BUILD_GUIDE.md"
            exit 1
          fi

          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -sdk iphoneos \
            -configuration Release \
            -archivePath $RUNNER_TEMP/MornHub.xcarchive \
            archive

      - name: å¯¼å‡º IPA
        continue-on-error: true
        working-directory: desktop-apps/ios-capacitor/ios/App
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "âš ï¸  è·³è¿‡ IPA å¯¼å‡º"
            exit 1
          fi

          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/MornHub.xcarchive \
            -exportPath $RUNNER_TEMP/export \
            -exportOptionsPlist ExportOptions.plist

      - name: ä¸Šä¼  IPA
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: SiteHub-iOS
          path: ${{ runner.temp }}/export/*.ipa
          retention-days: 30

  # ===== Windows æž„å»º =====
  build-windows:
    name: ðŸªŸ æž„å»º Windows MSI
    runs-on: windows-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal

      - name: å®‰è£… Tauri CLI
        run: cargo install tauri-cli

      - name: æž„å»º Windows åº”ç”¨
        working-directory: desktop-apps/windows-tauri
        run: cargo tauri build

      - name: ä¸Šä¼  MSI
        uses: actions/upload-artifact@v4
        with:
          name: SiteHub-Windows
          path: desktop-apps/windows-tauri/src-tauri/target/release/bundle/msi/*.msi
          retention-days: 30

  # ===== æ±‡æ€»æ‰€æœ‰æž„å»ºäº§ç‰© =====
  package-all:
    name: ðŸ“¦ æ‰“åŒ…æ‰€æœ‰å®‰è£…åŒ…
    needs: [build-android, build-mac, build-windows, build-ios]
    runs-on: ubuntu-latest
    if: always() # å³ä½¿æŸäº›æž„å»ºå¤±è´¥ä¹Ÿç»§ç»­æ‰“åŒ…

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: release-packages

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          cd release-packages
          ls -R

      - name: ä¸Šä¼ å®Œæ•´å‘å¸ƒåŒ…
        uses: actions/upload-artifact@v4
        with:
          name: SiteHub-AllPlatforms-Release
          path: release-packages/
          retention-days: 30

      - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        run: |
          echo "# ðŸŽ‰ å››ç«¯æž„å»ºå®Œæˆ" > build-report.md
          echo "" >> build-report.md
          echo "## ðŸ“¦ å·²ç”Ÿæˆçš„å®‰è£…åŒ…:" >> build-report.md
          echo "" >> build-report.md
          echo "- âœ… Android APK" >> build-report.md
          echo "- âœ… Mac DMG (Intel x64)" >> build-report.md
          echo "- âœ… Mac DMG (Apple Silicon ARM64)" >> build-report.md
          echo "- âœ… Windows MSI" >> build-report.md
          echo "- âœ… iOS IPA (éœ€è¦é…ç½®è¯ä¹¦)" >> build-report.md
          echo "" >> build-report.md
          echo "## ðŸ“¥ ä¸‹è½½æ–¹å¼:" >> build-report.md
          echo "1. è¿›å…¥ GitHub Actions é¡µé¢" >> build-report.md
          echo "2. ç‚¹å‡»æœ¬æ¬¡è¿è¡Œè®°å½•" >> build-report.md
          echo "3. åœ¨ Artifacts åŒºåŸŸä¸‹è½½ **SiteHub-AllPlatforms-Release.zip**" >> build-report.md
          cat build-report.md

      - name: ä¸Šä¼ æž„å»ºæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
          retention-days: 30
