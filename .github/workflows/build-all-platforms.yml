name: ðŸš€ æ¡Œé¢ç«¯è‡ªåŠ¨æž„å»º

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘ï¼Œå¯é€‰æ‹©å¹³å°
    inputs:
      platform:
        description: 'é€‰æ‹©è¦æž„å»ºçš„å¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mac
          - windows
  push:
    branches:
      - main
    paths:
      - 'desktop-apps/**'
      - '.github/workflows/build-all-platforms.yml'

jobs:
  # ===== Mac æž„å»º =====
  build-mac:
    name: ðŸŽ æž„å»º Mac DMG (Apple Silicon)
    runs-on: macos-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal

      - name: æ·»åŠ  Rust ç›®æ ‡ (Apple Silicon)
        run: |
          rustup target add aarch64-apple-darwin

      - name: å®‰è£… Tauri CLI
        run: cargo install tauri-cli

      - name: æž„å»º Mac ARM64
        working-directory: desktop-apps/mac-tauri
        run: cargo tauri build --target aarch64-apple-darwin

      - name: ä¸Šä¼  DMG (ARM64)
        uses: actions/upload-artifact@v4
        with:
          name: sitehub-mac-arm64
          path: desktop-apps/mac-tauri/src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
          retention-days: 30

  # ===== Windows æž„å»º =====
  build-windows:
    name: ðŸªŸ æž„å»º Windows MSI
    runs-on: windows-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal

      - name: å®‰è£… Tauri CLI
        run: cargo install tauri-cli

      - name: æž„å»º Windows åº”ç”¨
        working-directory: desktop-apps/windows-tauri
        run: cargo tauri build

      - name: ä¸Šä¼  MSI
        uses: actions/upload-artifact@v4
        with:
          name: sitehub-windows
          path: desktop-apps/windows-tauri/src-tauri/target/release/bundle/msi/*.msi
          retention-days: 30

  # ===== æ±‡æ€»æ‰€æœ‰æž„å»ºäº§ç‰© =====
  package-all:
    name: ðŸ“¦ æ‰“åŒ…æ‰€æœ‰å®‰è£…åŒ…
    needs: [build-mac, build-windows]
    runs-on: ubuntu-latest
    if: always() # å³ä½¿æŸäº›æž„å»ºå¤±è´¥ä¹Ÿç»§ç»­æ‰“åŒ…

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: release-packages

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          cd release-packages
          ls -R

      - name: ä¸Šä¼ å®Œæ•´å‘å¸ƒåŒ…
        uses: actions/upload-artifact@v4
        with:
          name: sitehub-desktop-release
          path: release-packages/
          retention-days: 30

      - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        run: |
          echo "# ðŸŽ‰ æ¡Œé¢ç«¯æž„å»ºå®Œæˆ" > build-report.md
          echo "" >> build-report.md
          echo "## ðŸ“¦ å·²ç”Ÿæˆçš„å®‰è£…åŒ…:" >> build-report.md
          echo "" >> build-report.md
          echo "- âœ… Mac DMG (Apple Silicon ARM64)" >> build-report.md
          echo "- âœ… Windows MSI" >> build-report.md
          echo "" >> build-report.md
          echo "## ðŸ“¥ ä¸‹è½½æ–¹å¼:" >> build-report.md
          echo "1. è¿›å…¥ GitHub Actions é¡µé¢" >> build-report.md
          echo "2. ç‚¹å‡»æœ¬æ¬¡è¿è¡Œè®°å½•" >> build-report.md
          echo "3. åœ¨ Artifacts åŒºåŸŸä¸‹è½½ **sitehub-desktop-release.zip**" >> build-report.md
          cat build-report.md

      - name: ä¸Šä¼ æž„å»ºæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
          retention-days: 30
